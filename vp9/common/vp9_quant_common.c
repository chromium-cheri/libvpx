/*
 *  Copyright (c) 2010 The WebM project authors. All Rights Reserved.
 *
 *  Use of this source code is governed by a BSD-style license
 *  that can be found in the LICENSE file in the root of the source
 *  tree. An additional intellectual property rights grant can be found
 *  in the file PATENTS.  All contributing project authors may
 *  be found in the AUTHORS file in the root of the source tree.
 */

#include "vp9/common/vp9_common.h"
#include "vp9/common/vp9_quant_common.h"
#include "vp9/common/vp9_seg_common.h"

#if 1
static const int16_t dc_qlookup[QINDEX_RANGE] = {
  4,       8,    8,    9,   10,   11,   12,   12,
  13,     14,   15,   16,   17,   18,   19,   19,
  20,     21,   22,   23,   24,   25,   26,   26,
  27,     28,   29,   30,   31,   32,   32,   33,
  34,     35,   36,   37,   38,   38,   39,   40,
  41,     42,   43,   43,   44,   45,   46,   47,
  48,     48,   49,   50,   51,   52,   53,   53,
  54,     55,   56,   57,   57,   58,   59,   60,
  61,     62,   62,   63,   64,   65,   66,   66,
  67,     68,   69,   70,   70,   71,   72,   73,
  74,     74,   75,   76,   77,   78,   78,   79,
  80,     81,   81,   82,   83,   84,   85,   85,
  87,     88,   90,   92,   93,   95,   96,   98,
  99,    101,  102,  104,  105,  107,  108,  110,
  111,   113,  114,  116,  117,  118,  120,  121,
  123,   125,  127,  129,  131,  134,  136,  138,
  140,   142,  144,  146,  148,  150,  152,  154,
  156,   158,  161,  164,  166,  169,  172,  174,
  177,   180,  182,  185,  187,  190,  192,  195,
  199,   202,  205,  208,  211,  214,  217,  220,
  223,   226,  230,  233,  237,  240,  243,  247,
  250,   253,  257,  261,  265,  269,  272,  276,
  280,   284,  288,  292,  296,  300,  304,  309,
  313,   317,  322,  326,  330,  335,  340,  344,
  349,   354,  359,  364,  369,  374,  379,  384,
  389,   395,  400,  406,  411,  417,  423,  429,
  435,   441,  447,  454,  461,  467,  475,  482,
  489,   497,  505,  513,  522,  530,  539,  549,
  559,   569,  579,  590,  602,  614,  626,  640,
  654,   668,  684,  700,  717,  736,  755,  775,
  796,   819,  843,  869,  896,  925,  955,  988,
  1022, 1058, 1098, 1139, 1184, 1232, 1282, 1336,
};

#if CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS && CONFIG_HIGH_QUANT
static const int16_t dc_qlookup_10[QINDEX_RANGE] = {
  8,    15,    17,    19,    21,    23,    25,    27,
  29,    31,    33,    35,    36,    38,    40,    42,
  44,    47,    49,    51,    53,    55,    57,    59,
  61,    63,    65,    67,    70,    72,    74,    76,
  78,    80,    83,    85,    87,    89,    92,    94,
  96,    98,   101,   103,   105,   108,   110,   112,
  115,   117,   119,   122,   124,   126,   129,   131,
  134,   136,   139,   141,   144,   146,   149,   151,
  154,   156,   159,   161,   164,   166,   169,   171,
  174,   177,   179,   182,   184,   187,   190,   192,
  195,   198,   200,   203,   206,   209,   211,   214,
  217,   219,   222,   225,   228,   231,   233,   236,
  241,   246,   251,   256,   261,   266,   271,   276,
  281,   286,   291,   296,   301,   306,   312,   317,
  322,   327,   332,   337,   342,   348,   353,   358,
  363,   371,   378,   385,   393,   400,   408,   415,
  422,   430,   437,   445,   452,   460,   467,   474,
  482,   489,   499,   508,   518,   527,   537,   546,
  556,   566,   575,   585,   594,   604,   613,   624,
  636,   647,   659,   670,   682,   693,   704,   716,
  727,   740,   754,   767,   780,   793,   806,   819,
  832,   845,   860,   875,   889,   904,   919,   933,
  948,   964,   980,   997,  1013,  1029,  1045,  1063,
  1080,  1098,  1115,  1133,  1150,  1169,  1188,  1207,
  1226,  1245,  1266,  1286,  1307,  1327,  1348,  1370,
  1392,  1414,  1436,  1459,  1483,  1507,  1531,  1556,
  1582,  1608,  1634,  1662,  1690,  1718,  1748,  1778,
  1809,  1842,  1876,  1909,  1946,  1982,  2020,  2060,
  2101,  2143,  2188,  2234,  2283,  2334,  2386,  2441,
  2499,  2561,  2625,  2693,  2764,  2841,  2920,  3006,
  3094,  3190,  3290,  3397,  3509,  3630,  3756,  3891,
  4033,  4186,  4351,  4524,  4710,  4910,  5121,  5347,
};

static const int16_t dc_qlookup_12[QINDEX_RANGE] = {
  16,  31,  35,  40,  44,  48,  52,  57,
  61,  66,  71,  75,  80,  85,  90,  95,
  100,  105,  111,  116,  121,  127,  132,  138,
  144,  149,  155,  161,  167,  173,  180,  186,
  192,  198,  205,  211,  218,  225,  231,  238,
  245,  252,  259,  266,  273,  281,  288,  295,
  303,  310,  318,  326,  333,  341,  349,  357,
  365,  373,  381,  389,  398,  406,  414,  423,
  431,  440,  449,  458,  466,  475,  484,  493,
  502,  512,  521,  530,  539,  549,  558,  568,
  578,  587,  597,  607,  617,  627,  637,  647,
  657,  667,  677,  688,  698,  709,  719,  730,
  747,  764,  782,  800,  817,  835,  853,  871,
  889,   907,   926,   944,   963,   981,  1000,  1019,
  1038,  1057,  1076,  1095,  1115,  1134,  1154,  1173,
  1193,  1220,  1247,  1274,  1301,  1328,  1356,  1383,
  1411,  1439,  1466,  1494,  1522,  1551,  1579,  1607,
  1636,  1664,  1700,  1736,  1772,  1808,  1844,  1880,
  1916,  1953,  1989,  2026,  2062,  2099,  2136,  2180,
  2224,  2268,  2312,  2356,  2400,  2444,  2488,  2533,
  2577,  2628,  2680,  2731,  2782,  2834,  2885,  2936,
  2988,  3039,  3097,  3155,  3214,  3272,  3330,  3388,
  3446,  3510,  3575,  3639,  3703,  3768,  3832,  3903,
  3973,  4044,  4114,  4185,  4255,  4332,  4408,  4485,
  4561,  4638,  4721,  4804,  4887,  4970,  5053,  5142,
  5231,  5321,  5411,  5508,  5604,  5701,  5799,  5903,
  6008,  6114,  6220,  6334,  6448,  6564,  6687,  6812,
  6938,  7073,  7210,  7349,  7497,  7648,  7802,  7966,
  8133,  8305,  8488,  8676,  8878,  9084,  9297,  9525,
  9760,  10013,  10274,  10554,  10844,  11156,  11480,  11828,
  12191,  12581,  12987,  13425,  13882,  14374,  14888,  15442,
  16021,  16646,  17319,  18024,  18784,  19603,  20462,  21388,
};
#endif

static const int16_t ac_qlookup[QINDEX_RANGE] = {
  4,       8,    9,   10,   11,   12,   13,   14,
  15,     16,   17,   18,   19,   20,   21,   22,
  23,     24,   25,   26,   27,   28,   29,   30,
  31,     32,   33,   34,   35,   36,   37,   38,
  39,     40,   41,   42,   43,   44,   45,   46,
  47,     48,   49,   50,   51,   52,   53,   54,
  55,     56,   57,   58,   59,   60,   61,   62,
  63,     64,   65,   66,   67,   68,   69,   70,
  71,     72,   73,   74,   75,   76,   77,   78,
  79,     80,   81,   82,   83,   84,   85,   86,
  87,     88,   89,   90,   91,   92,   93,   94,
  95,     96,   97,   98,   99,  100,  101,  102,
  104,   106,  108,  110,  112,  114,  116,  118,
  120,   122,  124,  126,  128,  130,  132,  134,
  136,   138,  140,  142,  144,  146,  148,  150,
  152,   155,  158,  161,  164,  167,  170,  173,
  176,   179,  182,  185,  188,  191,  194,  197,
  200,   203,  207,  211,  215,  219,  223,  227,
  231,   235,  239,  243,  247,  251,  255,  260,
  265,   270,  275,  280,  285,  290,  295,  300,
  305,   311,  317,  323,  329,  335,  341,  347,
  353,   359,  366,  373,  380,  387,  394,  401,
  408,   416,  424,  432,  440,  448,  456,  465,
  474,   483,  492,  501,  510,  520,  530,  540,
  550,   560,  571,  582,  593,  604,  615,  627,
  639,   651,  663,  676,  689,  702,  715,  729,
  743,   757,  771,  786,  801,  816,  832,  848,
  864,   881,  898,  915,  933,  951,  969,  988,
  1007, 1026, 1046, 1066, 1087, 1108, 1129, 1151,
  1173, 1196, 1219, 1243, 1267, 1292, 1317, 1343,
  1369, 1396, 1423, 1451, 1479, 1508, 1537, 1567,
  1597, 1628, 1660, 1692, 1725, 1759, 1793, 1828,
};

#if CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS && CONFIG_HIGH_QUANT
static const int16_t ac_qlookup_10[QINDEX_RANGE] = {
  8,    16,    18,    20,    22,    25,    27,    29,
  31,    33,    35,    38,    40,    42,    44,    47,
  49,    51,    54,    56,    58,    61,    63,    66,
  68,    71,    73,    75,    78,    80,    83,    86,
  88,    91,    93,    96,    98,   101,   104,   106,
  109,   112,   114,   117,   120,   123,   125,   128,
  131,   134,   137,   140,   142,   145,   148,   151,
  154,   157,   160,   163,   166,   169,   172,   175,
  178,   181,   184,   187,   190,   194,   197,   200,
  203,   206,   209,   213,   216,   219,   222,   226,
  229,   232,   236,   239,   242,   246,   249,   253,
  256,   260,   263,   266,   270,   273,   277,   281,
  287,   293,   300,   306,   312,   319,   325,   332,
  338,   345,   352,   358,   365,   372,   378,   385,
  392,   399,   406,   413,   420,   427,   434,   441,
  448,   458,   468,   478,   488,   498,   509,   519,
  529,   540,   550,   561,   571,   582,   593,   603,
  614,   625,   639,   653,   667,   681,   695,   709,
  724,   738,   752,   767,   782,   796,   811,   829,
  847,   865,   883,   901,   920,   938,   956,   975,
  994,  1016,  1038,  1060,  1082,  1104,  1127,  1149,
  1172,  1195,  1221,  1247,  1274,  1300,  1327,  1353,
  1380,  1411,  1441,  1472,  1502,  1533,  1564,  1598,
  1633,  1668,  1703,  1738,  1773,  1812,  1851,  1890,
  1929,  1969,  2012,  2055,  2099,  2142,  2186,  2234,
  2281,  2329,  2377,  2429,  2481,  2534,  2586,  2643,
  2699,  2756,  2813,  2874,  2935,  2996,  3062,  3127,
  3193,  3262,  3332,  3403,  3477,  3551,  3626,  3705,
  3784,  3864,  3947,  4031,  4119,  4207,  4295,  4388,
  4481,  4578,  4676,  4778,  4880,  4986,  5093,  5204,
  5316,  5431,  5547,  5668,  5789,  5914,  6040,  6170,
  6301,  6436,  6575,  6715,  6860,  7009,  7158,  7312,
};

static const int16_t ac_qlookup_12[QINDEX_RANGE] = {
  16,  33,  37,  42,  47,  51,  56,  61,
  66,   72,   77,   82,   88,   93,   99,  105,
  110,  116,  122,  128,  135,  141,  147,  154,
  160,  167,  174,  181,  188,  195,  202,  209,
  216,  224,  231,  239,  247,  254,  262,  270,
  278,  287,  295,  303,  312,  320,  329,  338,
  346,  355,  364,  373,  383,  392,  401,  411,
  420,  430,  440,  450,  460,  470,  480,  490,
  500,  511,  521,  532,  543,  553,  564,  575,
  586,  598,  609,  620,  632,  643,  655,  667,
  678,  690,  702,  714,  727,  739,  751,  764,
  776,  789,  802,  815,  828,  841,  854,  867,
  889,   911,   933,   956,   978,  1001,  1024,  1047,
  1071,  1094,  1118,  1142,  1166,  1190,  1215,  1240,
  1264,  1289,  1315,  1340,  1366,  1392,  1418,  1444,
  1470,  1506,  1543,  1580,  1617,  1654,  1692,  1730,
  1768,  1807,  1846,  1885,  1924,  1964,  2004,  2044,
  2084,  2125,  2177,  2229,  2281,  2334,  2387,  2440,
  2494,  2548,  2603,  2658,  2713,  2769,  2825,  2893,
  2961,  3029,  3098,  3168,  3237,  3308,  3379,  3450,
  3522,  3606,  3690,  3775,  3861,  3947,  4033,  4121,
  4208,  4297,  4398,  4499,  4602,  4704,  4808,  4912,
  5017,  5135,  5254,  5373,  5493,  5614,  5736,  5871,
  6006,  6143,  6281,  6419,  6558,  6711,  6865,  7020,
  7176,  7333,  7503,  7675,  7848,  8022,  8197,  8386,
  8577,   8768,   8961,   9168,   9377,   9587,   9798,  10024,
  10251,  10480,  10710,  10955,  11201,  11450,  11713,  11978,
  12245,  12527,  12811,  13096,  13397,  13700,  14005,  14326,
  14649,  14973,  15314,  15657,  16016,  16378,  16741,  17121,
  17503,  17903,  18304,  18723,  19144,  19582,  20023,  20481,
  20941,  21420,  21901,  22400,  22901,  23421,  23944,  24484,
  25028,  25590,  26171,  26755,  27357,  27979,  28604,  29248,
};
#endif


void vp9_init_quant_tables(void) { }
#else
static int16_t dc_qlookup[QINDEX_RANGE];
static int16_t ac_qlookup[QINDEX_RANGE];

#define ACDC_MIN 8

// TODO(dkovalev) move to common and reuse
static double poly3(double a, double b, double c, double d, double x) {
  return a*x*x*x + b*x*x + c*x + d;
}

void vp9_init_quant_tables() {
  int i, val = 4;

  // A "real" q of 1.0 forces lossless mode.
  // In practice non lossless Q's between 1.0 and 2.0 (represented here by
  // integer values from 5-7 give poor rd results (lower psnr and often
  // larger size than the lossless encode. To block out those "not very useful"
  // values we increment the ac and dc q lookup values by 4 after position 0.
  ac_qlookup[0] = val;
  dc_qlookup[0] = val;
  val += 4;

  for (i = 1; i < QINDEX_RANGE; i++) {
    const int ac_val = val;

    val = (int)(val * 1.01975);
    if (val == ac_val)
      ++val;

    ac_qlookup[i] = (int16_t)ac_val;
    dc_qlookup[i] = (int16_t)MAX(ACDC_MIN, poly3(0.000000305, -0.00065, 0.9,
                                                 0.5, ac_val));
  }
}
#endif

int16_t vp9_dc_quant(int qindex, int delta, vpx_bit_depth_t bit_depth) {
#if CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS && CONFIG_HIGH_QUANT
  switch (bit_depth) {
    case VPX_BITS_8:
      return dc_qlookup[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_10:
      return dc_qlookup_10[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_12:
      return dc_qlookup_12[clamp(qindex + delta, 0, MAXQ)];
    default:
      assert(0 && "bit_depth should be VPX_BITS_8, VPX_BITS_10 or VPX_BITS_12");
  }
#elif CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS
  switch (bit_depth) {
    case VPX_BITS_8:
      return dc_qlookup[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_10:
      return dc_qlookup[clamp(qindex + delta, 0, MAXQ)] << 2;
    case VPX_BITS_12:
      return dc_qlookup[clamp(qindex + delta, 0, MAXQ)] << 4;
    default:
      assert(0 && "bit_depth should be VPX_BITS_8, VPX_BITS_10 or VPX_BITS_12");
  }
#else
  (void) bit_depth;
  return dc_qlookup[clamp(qindex + delta, 0, MAXQ)];
#endif
}

int16_t vp9_ac_quant(int qindex, int delta, vpx_bit_depth_t bit_depth) {
#if CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS && CONFIG_HIGH_QUANT
  switch (bit_depth) {
    case VPX_BITS_8:
      return ac_qlookup[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_10:
      return ac_qlookup_10[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_12:
      return ac_qlookup_12[clamp(qindex + delta, 0, MAXQ)];
    default:
      assert(0 && "bit_depth should be VPX_BITS_8, VPX_BITS_10 or VPX_BITS_12");
  }
#elif CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS
  switch (bit_depth) {
    case VPX_BITS_8:
      return ac_qlookup[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_10:
      return ac_qlookup[clamp(qindex + delta, 0, MAXQ)] << 2;
    case VPX_BITS_12:
      return ac_qlookup[clamp(qindex + delta, 0, MAXQ)] << 4;
    default:
      assert(0 && "bit_depth should be VPX_BITS_8, VPX_BITS_10 or VPX_BITS_12");
  }
#else
  (void) bit_depth;
  return ac_qlookup[clamp(qindex + delta, 0, MAXQ)];
#endif
}

int vp9_get_qindex(const struct segmentation *seg, int segment_id,
                   int base_qindex, vpx_bit_depth_t bit_depth) {
  if (vp9_segfeature_active(seg, segment_id, SEG_LVL_ALT_Q)) {
    const int data = vp9_get_segdata(seg, segment_id, SEG_LVL_ALT_Q);
    const int seg_qindex = seg->abs_delta == SEGMENT_ABSDATA ?
        data : base_qindex + data;
    return clamp(seg_qindex, 0, MAXQ);
  } else {
    return base_qindex;
  }
}
