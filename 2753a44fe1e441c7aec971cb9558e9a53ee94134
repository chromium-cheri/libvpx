{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "791d1279_75f5908e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1196199
      },
      "writtenOn": "2022-10-13T01:17:13Z",
      "side": 1,
      "message": "Does this work when the number of layers are changed like 2-\u003e1, 1-\u003e2, \u003e2-\u003e1, ...?\n\nLooks like key_frame_rate_correction_factor is reset to 1.0 when the number of temporal layers is changed from 2 to 1.",
      "revId": "2753a44fe1e441c7aec971cb9558e9a53ee94134",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fcac0ade_71db69d1",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1126910
      },
      "writtenOn": "2022-10-13T03:39:23Z",
      "side": 1,
      "message": "I think it should work because of the logic in vp8_reset_temporal_layer_change():\n...\n   (i \u003d 0; i \u003c curr_num_layers; ++i) {\n    LAYER_CONTEXT *lc \u003d \u0026cpi-\u003elayer_context[i];\n    if (i \u003e\u003d prev_num_layers) {\n      vp8_init_temporal_layer_context(cpi, oxcf, i, prev_layer_framerate);\n    }\n...\nSo for 2 -\u003e 1 it should not call vp8_init_temporal_layer_context(), since prev_num_layers would be 2 and curr_num_layers \u003d 1, so the key_frame_rate_correction_factor should not be reset to 1.\n\nBut since we currently don\u0027t have any tests to cover that case, there could be an issue with 2-\u003e1. Can you try it with your tests and let us know?",
      "parentUuid": "791d1279_75f5908e",
      "revId": "2753a44fe1e441c7aec971cb9558e9a53ee94134",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "68ad82b1_bba9e8b2",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1196199
      },
      "writtenOn": "2022-10-14T13:51:04Z",
      "side": 1,
      "message": "Hi, today I did dynamically layers change in our test [1] with adding libvpx debug log [2].\n[3] is the test output.\n\n```\n2022-10-14T13:36:29.607610Z VERBOSE2 video_encode_accelerator_tests: [vp8_vaapi_video_encoder_delegate.cc(457)] UpdateRates(): The number of temporal layers is changed, from 2 to 1\nused_key_frame_rate_correction_factor\u003d1.000000\nQ\u003d89\n```\n\nI think it is unintended that used_key_frame_rate_correction_factor is always 1.0 when the num of layers is changed to 1 from 2.\nam I wrong?\n\n[1] https://chromium-review.googlesource.com/c/chromium/src/+/3956814\n[2] https://paste.googleplex.com/4860817446010880\n[3] https://drive.google.com/file/d/1Lez4OlpGoRENUeWcz6lOOlyuImE_CyT5/view?usp\u003dsharing",
      "parentUuid": "fcac0ade_71db69d1",
      "revId": "2753a44fe1e441c7aec971cb9558e9a53ee94134",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "00cba6ce_b92f0ce2",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1126910
      },
      "writtenOn": "2022-10-14T15:57:21Z",
      "side": 1,
      "message": "Ok thanks for the runs and the data.\n\nSo it seems work fine for 1-\u003e2, but not 2-\u003e1?\n\nCan you add print/log inside UpdateRateControl(), at lines 133, to see what (current_video_frame, oxcf-\u003enumber_of_layers, prrev_number_of_layers) are?\nTo see if we enter vp8_reset_temporal_layer_change (as expected), or if we directly enter vp8_init_temporal_layer_context() for all layers (1 and 2, which would be wrong).",
      "parentUuid": "68ad82b1_bba9e8b2",
      "revId": "2753a44fe1e441c7aec971cb9558e9a53ee94134",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c0053154_bf3e3ddc",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1196199
      },
      "writtenOn": "2022-10-14T16:25:14Z",
      "side": 1,
      "message": "Neither of them in 2-\u003e1.\n```\n2022-10-14T16:21:34.774458Z VERBOSE2 video_encode_accelerator_tests: [vp8_vaapi_video_encoder_delegate.cc(457)] UpdateRates(): The number of temporal layers is changed, from 2 to 1\ncm-\u003ecurrent_video_frame: 240, oxcf-\u003enumber_of_layers: 1, prev_number_of_layers: 2\nused_key_frame_rate_correction_factor\u003d1.000000\nQ\u003d89\n```\n\nI think we need to fix `if (oxcf-\u003enumber_of_layers \u003e 1) {` in l.128.\n\nFWIW, 1-\u003e2 looks good.\n```\n2022-10-14T16:21:34.153383Z VERBOSE2 video_encode_accelerator_tests: [vp8_vaapi_video_encoder_delegate.cc(457)] UpdateRates(): The number of temporal layers is changed, from 1 to 2\ncm-\u003ecurrent_video_frame: 180, oxcf-\u003enumber_of_layers: 2, prev_number_of_layers: 1\nvp8_reset_temporal_layer_change\nused_key_frame_rate_correction_factor\u003d0.790000\n```",
      "parentUuid": "00cba6ce_b92f0ce2",
      "revId": "2753a44fe1e441c7aec971cb9558e9a53ee94134",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4283e428_9e60ff3a",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1126910
      },
      "writtenOn": "2022-10-14T19:31:55Z",
      "side": 1,
      "message": "Added the condition:\nif (oxcf-\u003enumber_of_layers \u003e 1 || prev_number_of_layers \u003e 1), \n\ncan you test if this works. Don\u0027t want to do:if (oxcf-\u003enumber_of_layers \u003e\u003d 1) since we will then enter unneeded code for 1 layer case.",
      "parentUuid": "c0053154_bf3e3ddc",
      "revId": "2753a44fe1e441c7aec971cb9558e9a53ee94134",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a3e6ea19_ce412b43",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1196199
      },
      "writtenOn": "2022-10-15T00:50:12Z",
      "side": 1,
      "message": "Alright. The result looks good.",
      "parentUuid": "4283e428_9e60ff3a",
      "revId": "2753a44fe1e441c7aec971cb9558e9a53ee94134",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}