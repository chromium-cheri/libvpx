/*
 *  Copyright (c) 2010 The WebM project authors. All Rights Reserved.
 *
 *  Use of this source code is governed by a BSD-style license
 *  that can be found in the LICENSE file in the root of the source
 *  tree. An additional intellectual property rights grant can be found
 *  in the file PATENTS.  All contributing project authors may
 *  be found in the AUTHORS file in the root of the source tree.
 */

#include "vp9/common/vp9_common.h"
#include "vp9/common/vp9_quant_common.h"
#include "vp9/common/vp9_seg_common.h"

#if 1
static const int16_t dc_qlookup[QINDEX_RANGE] = {
  4,       8,    8,    9,   10,   11,   12,   12,
  13,     14,   15,   16,   17,   18,   19,   19,
  20,     21,   22,   23,   24,   25,   26,   26,
  27,     28,   29,   30,   31,   32,   32,   33,
  34,     35,   36,   37,   38,   38,   39,   40,
  41,     42,   43,   43,   44,   45,   46,   47,
  48,     48,   49,   50,   51,   52,   53,   53,
  54,     55,   56,   57,   57,   58,   59,   60,
  61,     62,   62,   63,   64,   65,   66,   66,
  67,     68,   69,   70,   70,   71,   72,   73,
  74,     74,   75,   76,   77,   78,   78,   79,
  80,     81,   81,   82,   83,   84,   85,   85,
  87,     88,   90,   92,   93,   95,   96,   98,
  99,    101,  102,  104,  105,  107,  108,  110,
  111,   113,  114,  116,  117,  118,  120,  121,
  123,   125,  127,  129,  131,  134,  136,  138,
  140,   142,  144,  146,  148,  150,  152,  154,
  156,   158,  161,  164,  166,  169,  172,  174,
  177,   180,  182,  185,  187,  190,  192,  195,
  199,   202,  205,  208,  211,  214,  217,  220,
  223,   226,  230,  233,  237,  240,  243,  247,
  250,   253,  257,  261,  265,  269,  272,  276,
  280,   284,  288,  292,  296,  300,  304,  309,
  313,   317,  322,  326,  330,  335,  340,  344,
  349,   354,  359,  364,  369,  374,  379,  384,
  389,   395,  400,  406,  411,  417,  423,  429,
  435,   441,  447,  454,  461,  467,  475,  482,
  489,   497,  505,  513,  522,  530,  539,  549,
  559,   569,  579,  590,  602,  614,  626,  640,
  654,   668,  684,  700,  717,  736,  755,  775,
  796,   819,  843,  869,  896,  925,  955,  988,
  1022, 1058, 1098, 1139, 1184, 1232, 1282, 1336,
};

#if CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS && CONFIG_HIGH_QUANT
static const int16_t dc_qlookup_10[QINDEX_RANGE] = {
  4,     8,    10,    12,    14,    16,    18,    20,
  22,    24,    27,    29,    32,    35,    37,    40,
  43,    46,    49,    52,    55,    58,    61,    65,
  68,    71,    75,    78,    81,    85,    88,    92,
  95,    99,   102,   106,   109,   113,   117,   120,
  124,   128,   131,   135,   139,   142,   146,   150,
  154,   157,   161,   165,   168,   172,   176,   180,
  183,   187,   191,   194,   198,   202,   206,   209,
  213,   217,   220,   224,   228,   231,   235,   239,
  242,   246,   250,   253,   257,   261,   264,   268,
  271,   275,   279,   282,   286,   289,   293,   296,
  300,   303,   307,   310,   314,   317,   321,   324,
  331,   337,   343,   350,   356,   362,   369,   375,
  381,   388,   394,   400,   406,   412,   419,   425,
  431,   437,   443,   449,   455,   461,   467,   473,
  480,   488,   497,   506,   515,   523,   532,   540,
  549,   558,   566,   574,   583,   591,   600,   608,
  616,   625,   635,   646,   657,   668,   678,   689,
  700,   710,   720,   731,   741,   751,   762,   774,
  787,   799,   812,   824,   836,   848,   860,   872,
  884,   898,   913,   927,   940,   954,   968,   981,
  995,  1008,  1024,  1039,  1054,  1069,  1084,  1099,
  1114,  1131,  1147,  1164,  1180,  1196,  1212,  1230,
  1248,  1266,  1283,  1301,  1318,  1337,  1356,  1374,
  1393,  1411,  1432,  1452,  1472,  1492,  1511,  1533,
  1554,  1575,  1597,  1620,  1642,  1665,  1688,  1713,
  1737,  1762,  1787,  1813,  1840,  1867,  1896,  1925,
  1954,  1986,  2018,  2050,  2085,  2120,  2155,  2194,
  2233,  2273,  2316,  2359,  2407,  2455,  2505,  2558,
  2613,  2672,  2733,  2799,  2867,  2941,  3017,  3099,
  3184,  3276,  3372,  3475,  3583,  3699,  3819,  3950,
  4086,  4232,  4391,  4556,  4734,  4926,  5127,  5343,
};

static const int16_t dc_qlookup_12[QINDEX_RANGE] = {
  4,    11,    15,    21,    26,    33,    40,    47,
  55,    63,    72,    81,    90,   100,   110,   121,
  132,   143,   154,   166,   178,   190,   203,   215,
  228,   241,   255,   268,   282,   295,   309,   323,
  338,   352,   366,   381,   395,   410,   425,   439,
  454,   469,   484,   499,   514,   530,   545,   560,
  575,   590,   606,   621,   636,   652,   667,   682,
  698,   713,   728,   744,   759,   774,   790,   805,
  820,   835,   851,   866,   881,   896,   911,   926,
  941,   956,   971,   986,  1001,  1016,  1031,  1046,
  1061,  1075,  1090,  1105,  1119,  1134,  1149,  1163,
  1178,  1192,  1206,  1221,  1235,  1249,  1264,  1278,
  1304,  1329,  1355,  1381,  1406,  1432,  1457,  1482,
  1508,  1533,  1558,  1583,  1608,  1633,  1658,  1683,
  1708,  1733,  1757,  1782,  1807,  1831,  1856,  1880,
  1904,  1939,  1975,  2010,  2045,  2080,  2114,  2149,
  2183,  2218,  2252,  2286,  2320,  2353,  2387,  2421,
  2454,  2487,  2531,  2574,  2617,  2660,  2703,  2745,
  2788,  2830,  2872,  2913,  2955,  2996,  3037,  3087,
  3138,  3188,  3237,  3287,  3336,  3384,  3433,  3481,
  3529,  3586,  3642,  3698,  3754,  3809,  3863,  3918,
  3972,  4026,  4087,  4149,  4210,  4270,  4330,  4390,
  4449,  4516,  4583,  4648,  4714,  4779,  4843,  4915,
  4986,  5057,  5127,  5196,  5265,  5341,  5417,  5492,
  5566,  5640,  5721,  5802,  5882,  5961,  6040,  6126,
  6212,  6297,  6382,  6474,  6565,  6657,  6748,  6847,
  6945,  7044,  7143,  7250,  7357,  7464,  7580,  7696,
  7814,  7939,  8067,  8196,  8334,  8475,  8618,  8771,
  8928,  9087,  9258,  9434,  9622,  9816, 10015, 10228,
  10448, 10686, 10930, 11194, 11466, 11760, 12065, 12393,
  12734, 13102, 13485, 13897, 14327, 14791, 15274, 15795,
  16339, 16926, 17559, 18220, 18932, 19700, 20504, 21369,
};
#endif

static const int16_t ac_qlookup[QINDEX_RANGE] = {
  4,       8,    9,   10,   11,   12,   13,   14,
  15,     16,   17,   18,   19,   20,   21,   22,
  23,     24,   25,   26,   27,   28,   29,   30,
  31,     32,   33,   34,   35,   36,   37,   38,
  39,     40,   41,   42,   43,   44,   45,   46,
  47,     48,   49,   50,   51,   52,   53,   54,
  55,     56,   57,   58,   59,   60,   61,   62,
  63,     64,   65,   66,   67,   68,   69,   70,
  71,     72,   73,   74,   75,   76,   77,   78,
  79,     80,   81,   82,   83,   84,   85,   86,
  87,     88,   89,   90,   91,   92,   93,   94,
  95,     96,   97,   98,   99,  100,  101,  102,
  104,   106,  108,  110,  112,  114,  116,  118,
  120,   122,  124,  126,  128,  130,  132,  134,
  136,   138,  140,  142,  144,  146,  148,  150,
  152,   155,  158,  161,  164,  167,  170,  173,
  176,   179,  182,  185,  188,  191,  194,  197,
  200,   203,  207,  211,  215,  219,  223,  227,
  231,   235,  239,  243,  247,  251,  255,  260,
  265,   270,  275,  280,  285,  290,  295,  300,
  305,   311,  317,  323,  329,  335,  341,  347,
  353,   359,  366,  373,  380,  387,  394,  401,
  408,   416,  424,  432,  440,  448,  456,  465,
  474,   483,  492,  501,  510,  520,  530,  540,
  550,   560,  571,  582,  593,  604,  615,  627,
  639,   651,  663,  676,  689,  702,  715,  729,
  743,   757,  771,  786,  801,  816,  832,  848,
  864,   881,  898,  915,  933,  951,  969,  988,
  1007, 1026, 1046, 1066, 1087, 1108, 1129, 1151,
  1173, 1196, 1219, 1243, 1267, 1292, 1317, 1343,
  1369, 1396, 1423, 1451, 1479, 1508, 1537, 1567,
  1597, 1628, 1660, 1692, 1725, 1759, 1793, 1828,
};

#if CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS && CONFIG_HIGH_QUANT
static const int16_t ac_qlookup_10[QINDEX_RANGE] = {
  4,     9,    10,    12,    14,    17,    19,    21,
  24,    26,    29,    32,    35,    38,    41,    44,
  47,    51,    54,    58,    61,    65,    68,    72,
  76,    80,    83,    87,    91,    95,    99,   103,
  107,   111,   115,   120,   124,   128,   132,   136,
  141,   145,   149,   154,   158,   162,   167,   171,
  176,   180,   184,   189,   193,   198,   202,   207,
  211,   216,   220,   225,   229,   234,   238,   242,
  247,   251,   256,   260,   265,   269,   274,   278,
  283,   287,   292,   296,   301,   305,   310,   314,
  319,   323,   328,   332,   337,   341,   345,   350,
  354,   359,   363,   368,   372,   376,   381,   385,
  393,   402,   410,   418,   426,   434,   443,   451,
  459,   467,   475,   484,   492,   500,   508,   517,
  525,   533,   541,   550,   558,   566,   574,   583,
  591,   603,   615,   627,   639,   652,   664,   676,
  688,   700,   712,   725,   737,   749,   761,   773,
  785,   798,   814,   830,   846,   862,   878,   894,
  910,   927,   943,   959,   975,   991,  1007,  1027,
  1048,  1068,  1088,  1108,  1128,  1148,  1168,  1188,
  1208,  1233,  1257,  1281,  1305,  1329,  1353,  1377,
  1401,  1425,  1453,  1482,  1510,  1538,  1566,  1594,
  1622,  1654,  1686,  1718,  1750,  1782,  1815,  1851,
  1887,  1923,  1959,  1995,  2031,  2071,  2111,  2151,
  2191,  2231,  2275,  2320,  2364,  2408,  2452,  2500,
  2548,  2596,  2644,  2696,  2748,  2800,  2852,  2908,
  2964,  3021,  3077,  3137,  3197,  3257,  3321,  3385,
  3449,  3517,  3585,  3653,  3725,  3797,  3869,  3945,
  4021,  4097,  4178,  4258,  4342,  4426,  4510,  4598,
  4686,  4778,  4870,  4966,  5062,  5162,  5262,  5366,
  5470,  5578,  5686,  5798,  5910,  6026,  6142,  6263,
  6383,  6507,  6635,  6763,  6895,  7031,  7167,  7307,
};

static const int16_t ac_qlookup_12[QINDEX_RANGE] = {
  4,    11,    16,    22,    28,    35,    43,    51,
  59,    68,    78,    88,    99,   110,   121,   133,
  145,   158,   171,   184,   198,   211,   226,   240,
  255,   270,   285,   300,   316,   332,   348,   364,
  380,   397,   413,   430,   447,   464,   481,   498,
  516,   533,   551,   569,   586,   604,   622,   640,
  658,   676,   694,   712,   730,   749,   767,   785,
  804,   822,   840,   859,   877,   896,   914,   932,
  951,   969,   988,  1006,  1025,  1043,  1062,  1080,
  1099,  1117,  1135,  1154,  1172,  1191,  1209,  1227,
  1246,  1264,  1282,  1300,  1319,  1337,  1355,  1373,
  1392,  1410,  1428,  1446,  1464,  1482,  1500,  1518,
  1551,  1584,  1617,  1650,  1683,  1716,  1749,  1782,
  1815,  1848,  1881,  1915,  1948,  1981,  2014,  2047,
  2081,  2114,  2147,  2180,  2213,  2247,  2280,  2313,
  2346,  2395,  2444,  2492,  2541,  2590,  2639,  2687,
  2736,  2785,  2834,  2883,  2932,  2981,  3029,  3078,
  3127,  3176,  3241,  3305,  3370,  3434,  3499,  3564,
  3628,  3693,  3758,  3823,  3887,  3952,  4017,  4097,
  4178,  4258,  4339,  4419,  4500,  4581,  4661,  4742,
  4822,  4919,  5015,  5112,  5208,  5305,  5401,  5498,
  5594,  5691,  5803,  5916,  6028,  6141,  6253,  6366,
  6478,  6607,  6735,  6863,  6992,  7120,  7249,  7393,
  7538,  7682,  7826,  7971,  8115,  8276,  8436,  8596,
  8757,  8917,  9093,  9270,  9446,  9623,  9799,  9991,
  10184, 10376, 10568, 10777, 10985, 11193, 11402, 11626,
  11850, 12075, 12299, 12539, 12780, 13020, 13276, 13532,
  13789, 14061, 14333, 14606, 14894, 15182, 15470, 15775,
  16079, 16383, 16704, 17024, 17360, 17696, 18033, 18385,
  18737, 19105, 19474, 19858, 20242, 20642, 21043, 21459,
  21875, 22307, 22739, 23188, 23636, 24100, 24564, 25045,
  25525, 26021, 26533, 27045, 27574, 28118, 28662, 29222,
};
#endif


void vp9_init_quant_tables(void) { }
#else
static int16_t dc_qlookup[QINDEX_RANGE];
static int16_t ac_qlookup[QINDEX_RANGE];

#define ACDC_MIN 8

// TODO(dkovalev) move to common and reuse
static double poly3(double a, double b, double c, double d, double x) {
  return a*x*x*x + b*x*x + c*x + d;
}

void vp9_init_quant_tables() {
  int i, val = 4;

  // A "real" q of 1.0 forces lossless mode.
  // In practice non lossless Q's between 1.0 and 2.0 (represented here by
  // integer values from 5-7 give poor rd results (lower psnr and often
  // larger size than the lossless encode. To block out those "not very useful"
  // values we increment the ac and dc q lookup values by 4 after position 0.
  ac_qlookup[0] = val;
  dc_qlookup[0] = val;
  val += 4;

  for (i = 1; i < QINDEX_RANGE; i++) {
    const int ac_val = val;

    val = (int)(val * 1.01975);
    if (val == ac_val)
      ++val;

    ac_qlookup[i] = (int16_t)ac_val;
    dc_qlookup[i] = (int16_t)MAX(ACDC_MIN, poly3(0.000000305, -0.00065, 0.9,
                                                 0.5, ac_val));
  }
}
#endif

int16_t vp9_dc_quant(int qindex, int delta, vpx_bit_depth_t bit_depth) {
#if CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS && CONFIG_HIGH_QUANT
  switch (bit_depth) {
    case VPX_BITS_8:
      return dc_qlookup[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_10:
      return dc_qlookup_10[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_12:
      return dc_qlookup_12[clamp(qindex + delta, 0, MAXQ)];
    default:
      assert(0 && "bit_depth should be VPX_BITS_8, VPX_BITS_10 or VPX_BITS_12");
  }
#elif CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS
  switch (bit_depth) {
    case VPX_BITS_8:
      return dc_qlookup[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_10:
      return dc_qlookup[clamp(qindex + delta, 0, MAXQ)] << 2;
    case VPX_BITS_12:
      return dc_qlookup[clamp(qindex + delta, 0, MAXQ)] << 4;
    default:
      assert(0 && "bit_depth should be VPX_BITS_8, VPX_BITS_10 or VPX_BITS_12");
  }
#else
  (void) bit_depth;
  return dc_qlookup[clamp(qindex + delta, 0, MAXQ)];
#endif
}

int16_t vp9_ac_quant(int qindex, int delta, vpx_bit_depth_t bit_depth) {
#if CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS && CONFIG_HIGH_QUANT
  switch (bit_depth) {
    case VPX_BITS_8:
      return ac_qlookup[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_10:
      return ac_qlookup_10[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_12:
      return ac_qlookup_12[clamp(qindex + delta, 0, MAXQ)];
    default:
      assert(0 && "bit_depth should be VPX_BITS_8, VPX_BITS_10 or VPX_BITS_12");
  }
#elif CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS
  switch (bit_depth) {
    case VPX_BITS_8:
      return ac_qlookup[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_10:
      return ac_qlookup[clamp(qindex + delta, 0, MAXQ)] << 2;
    case VPX_BITS_12:
      return ac_qlookup[clamp(qindex + delta, 0, MAXQ)] << 4;
    default:
      assert(0 && "bit_depth should be VPX_BITS_8, VPX_BITS_10 or VPX_BITS_12");
  }
#else
  (void) bit_depth;
  return ac_qlookup[clamp(qindex + delta, 0, MAXQ)];
#endif
}

int vp9_get_qindex(const struct segmentation *seg, int segment_id,
                   int base_qindex, vpx_bit_depth_t bit_depth) {
  if (vp9_segfeature_active(seg, segment_id, SEG_LVL_ALT_Q)) {
    const int data = vp9_get_segdata(seg, segment_id, SEG_LVL_ALT_Q);
    const int seg_qindex = seg->abs_delta == SEGMENT_ABSDATA ?
        data : base_qindex + data;
    return clamp(seg_qindex, 0, MAXQ);
  } else {
    return base_qindex;
  }
}
